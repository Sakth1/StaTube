name: Build and Release

on:
  push:
    tags: ['v*']
  release:
    types: [published, created]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install build deps
        run: |
          python -m pip install --upgrade pip
          pip install nuitka pyside6 yt_dlp

      # -------------------------
      # A) Build STANDALONE (for installer)
      # -------------------------
      - name: Build (standalone for installer)
        run: |
          python -m nuitka `
            --standalone `
            --enable-plugin=pyside6 `
            --windows-console-mode=disable `
            --windows-icon-from-ico=assets/icon/youtube.ico `
            --include-package=yt_dlp `
            --include-module=yt_dlp.utils `
            --nofollow-import-to=yt_dlp.extractor.lazy_extractors `
            --include-data-dir=assets=assets `
            --include-data-dir=UI=UI `
            --assume-yes-for-downloads `
            main.py

      - name: Rename standalone exe
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}"; if ($version.StartsWith("v")) { $version = $version.Substring(1) }
          if (!(Test-Path "main.dist\main.exe")) { throw "Standalone exe not found" }
          Rename-Item -Path "main.dist\main.exe" -NewName "StaTube-$version.exe"

      # -------------------------
      # B) Build ONEFILE (portable single EXE)
      # -------------------------
      - name: Build (onefile portable)
        run: |
          python -m nuitka `
            --onefile `
            --onefile-tempdir-spec="%CACHE_DIR%" `
            --enable-plugin=pyside6 `
            --windows-console-mode=disable `
            --windows-icon-from-ico=assets/icon/youtube.ico `
            --include-package=yt_dlp `
            --include-module=yt_dlp.utils `
            --nofollow-import-to=yt_dlp.extractor.lazy_extractors `
            --include-data-dir=assets=assets `
            --include-data-dir=UI=UI `
            --assume-yes-for-downloads `
            main.py

      - name: Stage outputs (porables & installers)
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}"; if ($version.StartsWith("v")) { $version = $version.Substring(1) }

          # portable single exe from onefile build: Nuitka outputs "main.exe" in CWD
          if (!(Test-Path ".\main.exe")) { throw "Onefile portable exe not found (main.exe)" }
          New-Item -ItemType Directory -Force -Path porables, installers | Out-Null
          Move-Item -Path ".\main.exe" -Destination ".\porables\StaTube-$version-portable.exe" -Force

      # -------------------------
      # C) Build Installer (Inno Setup)
      # -------------------------
      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Generate Inno Setup script
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}"; if ($version.StartsWith("v")) { $version = $version.Substring(1) }
          $guid = "1F4E8E6B-7B8F-4C3C-9E7D-9F9F5B8D21B1"  # fixed AppId for upgrades

          $iss = @"
[Setup]
AppId={{$guid}}
AppName=StaTube
AppVersion=$version
DefaultDirName={pf}\StaTube
DisableDirPage=no
DefaultGroupName=StaTube
OutputDir=installers
OutputBaseFilename=StaTube-$version-installer
Compression=lzma
SolidCompression=yes
ArchitecturesInstallIn64BitMode=x64
PrivilegesRequired=admin
SetupIconFile=assets\icon\youtube.ico
UninstallDisplayIcon={app}\StaTube-$version.exe

[Files]
Source: "main.dist\*"; DestDir: "{app}"; Flags: recursesubdirs

[Icons]
Name: "{group}\StaTube"; Filename: "{app}\StaTube-$version.exe"
Name: "{group}\Uninstall StaTube"; Filename: "{uninstallexe}"
Name: "{autodesktop}\StaTube"; Filename: "{app}\StaTube-$version.exe"; Tasks: desktopicon

[Tasks]
Name: "desktopicon"; Description: "Create a &desktop icon"; GroupDescription: "Additional icons:"; Flags: unchecked

[Run]
Filename: "{app}\StaTube-$version.exe"; Description: "Launch StaTube"; Flags: nowait postinstall skipifsilent

[Registry]
; optional: store install path for future use
Root: HKCU; Subkey: "Software\StaTube"; ValueType: string; ValueName: "InstallPath"; ValueData: "{app}"; Flags: uninsdeletekey
"@
          Set-Content -Path installer.iss -Value $iss -Encoding UTF8

      - name: Compile Inno Setup
        run: '"C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss'

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ github.ref_name }}
          path: |
            porables/StaTube-*-portable.exe
            installers/StaTube-*-installer.exe
          retention-days: 7

  release:
    needs: build
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: build-*
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            Automatic build for ${{ github.ref_name }}

            **Included:**
            - Portable single EXE (porables/)
            - Installer (installers/)
          files: |
            porables/StaTube-*-portable.exe
            installers/StaTube-*-installer.exe
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
