name: Build and Release (Portable + Installer)
--include-data-file=UI/Style.qss=UI/Style.qss ^
--include-data-file=Data/schema.sql=Data/schema.sql ^
--assume-yes-for-downloads ^
main.py


- name: Validate standalone output
shell: pwsh
run: |
# Nuitka --standalone typically produces a main.dist folder
if (!(Test-Path "./standalone_build/main.dist")) { throw "Standalone build output not found: ./standalone_build/main.dist" }


- name: Prepare releases folder and copy standalone build
shell: pwsh
run: |
$version = "${{ steps.get_tag.outputs.tag }}"
New-Item -ItemType Directory -Force -Path $env:RELEASE_DIR | Out-Null
$target = "./$env:RELEASE_DIR/StaTube-$version-standalone-py${{ matrix.python-version }}"
if (Test-Path $target) { Remove-Item -Recurse -Force $target }
New-Item -ItemType Directory -Force -Path $target | Out-Null
Copy-Item -Recurse -Force .\standalone_build\main.dist\* $target


- name: Install Inno Setup (Chocolatey)
shell: powershell
run: |
choco install innosetup -y


- name: Compile Inno Setup installer
shell: powershell
env:
TAG: ${{ steps.get_tag.outputs.tag }}
OUTPUT_DIR: "${{ github.workspace }}\$RELEASE_DIR"
run: |
# read metadata (already exported to step outputs via $GITHUB_OUTPUT) â€” also safe to read file
$metaFile = "${{ github.workspace }}\build\installer\metadata.out"
if (!(Test-Path $metaFile)) { throw "metadata.out missing: $metaFile" }
$meta = Get-Content $metaFile | ConvertFrom-StringData
$appName = $meta.APP_NAME
$appVersion = $meta.APP_VERSION
$appPublisher = $meta.APP_PUBLISHER
$appDesc = $meta.APP_DESCRIPTION


$iss = "${{ github.workspace }}\$INSTALLER_SCRIPT"
if (!(Test-Path $iss)) { throw "Installer script not found: $iss" }


$source = "${{ github.workspace }}\$RELEASE_DIR\StaTube-$($env:TAG)-standalone-py${{ matrix.python-version }}"
if (!(Test-Path $source)) { throw "Source folder for Inno Setup missing: $source" }


$out = "${{ github.workspace }}\$RELEASE_DIR"


$defines = "/DMyAppName=\"$appName\" /DMyAppVersion=\"$appVersion\" /DMyAppPublisher=\"$appPublisher\" /DMyAppDescription=\"$appDesc\" /DSourceDir=\"$source\" /DOutputDir=\"$out\""
Write-Host "Running ISCC with: $defines $iss"


& "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" $defines $iss


- name: Validate installer produced
shell: pwsh
run: |
$version = "${{ steps.get_tag.outputs.tag }}"
$installerName = "StaTube-$version-setup.exe"
$installerPath = "./$env:RELEASE_DIR/$installerName"
if (!(Test-Path $installerPath)) { throw "Installer not produced at $installerPath" }


- name: Compute SHA256 for installer
shell: pwsh
run: |
$version = "${{ steps.get_tag.outputs.tag }}"
$installer = "./$env:RELEASE_DIR/StaTube-$version-setup.exe"
$hash = Get-FileHash -Algorithm SHA256 -Path $installer
$hashFile = "$installer.sha256.txt"
"$($hash.Hash) $(Split-Path $installer -Le
